<style>
	.ticket-border {
		border-radius: 10px;
		border: solid 1px #CCCCCC;
		margin: 10px 10px 0px 10px;
		padding: 10px;
		background-color: #fff;
		overflow: hidden;
	}
	
	.ticket-thumb {
		position: absolute;
		height: 70px;
		width: 70px;
		top: 10px;
		left: 10px;
		border-radius: 10px;
		border: solid 1px #CCCCCC;
		background-repeat: no-repeat;
		background-position: 50% 50%;
		background-size: contain;
	}
	
	.ticket-amount {
		height: 40px;
		line-height: 40px;
	}
	
	.ticket-mini, .ticket-content {
		height: 30px;
		line-height: 30px;
	}
	
	.ticket-amount, .ticket-mini {
		margin-left: 90px;
	}
	
	.ticket-amount r {
		font-size: 20px;
	}
	.ticket-amount span {
		font-size: 36px;
	}
	
	.ticket-amount r, .ticket-amount span {
		color: #009999;
	}
	
	.ticket-date {
		background-color: #009999;
		color: #fff;
		margin: 0 -10px -10px -10px;
		border-bottom-left-radius: 10px;
		border-bottom-right-radius: 10px;
		padding-left: 10px;
	}
	
	.ticket-ball {
		width: 16px;
		height: 8px;
		position: absolute;
		right: 61px;
		background-color: #efeff4;
	}
	
	.ticket-ball-top {
		top: 0px;
		border-left: solid #ccc 1px;
		border-bottom: solid #ccc 1px;
		-webkit-border-radius: 0 0 16px 16px;
	}
	
	.ticket-ball-bottom {
		bottom: 0px;
		border-right: solid #ccc 1px;
		border-top: solid #ccc 1px;
		-webkit-border-radius: 16px 16px 0 0;
	}
	
	ul.ticket-split {
		right: 55px;
		position: absolute;
		top: 10px;
		bottom: 10px;
		width: 5px;
		list-style: none;
		padding: 0;
		margin: 0;
		overflow: hidden;
	}
	
	ul.ticket-split li {
		height: 4px;
		width: 4px;
		margin: 0px 0px 4px 0px;
		padding: 0;
		border-radius: 4px;
		background-color: #efeff4;
	}
	
	.ticket-btn, .ticket-nav {
		position: absolute;
		top: 50%;
		-webkit-transform: translateY(-50%);
		right: 30px;
		width: 20px;
		white-space: pre-wrap;
		word-break: break-all;
		font-size: 17px;
		color: #999;
	}
	
	.ticket-nav {
		right: 8px;
	}
	
	.ticket-empty {
		position: absolute;
		top: 10px;
		right: 40px;
		font-size: 100px;
		color: #ccc;
		opacity: 0.3;
	}
	
	.ticket-disabled .ticket-amount r, .ticket-disabled .ticket-amount span {
		color: #999;
	}
	
	.ticket-disabled .ticket-date {
		background-color: #999;
	}
	
	.icon-yilingqu {
		color: #009999;
	}
	
	.tab {
		text-align: center;
		background-color: #fff;
		height: 40px;
		line-height: 40px;
		border-bottom: #ccc 1px solid;
	}
	
	.tab .cky-active {
		color: #F60;
		position: relative;
	}
	
	.tab .cky-active::after {
		content: " ";
		position: absolute;
		display: block;
		bottom: 0px;
		left:10px;
		right: 10px;
		height: 2px;
		background-color: #F60;
	}
	
	.mui-btn-block {
		margin: 10px 0;
	}
</style>
<header class="mui-bar mui-bar-nav">
	<button class="cky-back mui-btn mui-btn-link mui-pull-left">
		<i class="mui-icon mui-icon-left-nav"></i>
	</button>
	<h1 id="title" class="mui-title">{$title}</h1>
	<button class="mui-btn mui-btn-link mui-pull-right">使用说明</button>
</header>

<div class="mui-content">
	<div id="tab" class="cky-col-view tab">
		<div class="cky-col-view-cell cky-active" tab-type="0">未使用({$data.unuse})</div>
		<div class="cky-col-view-cell" tab-type="1">已过期({$data.overdue})</div>
		<div class="cky-col-view-cell" tab-type="2">已使用({$data.used})</div>
	</div>
	
	<div id="couponsLoading" class="mui-loading">
		<div class="mui-spinner">
		</div>
	</div>
	<div id="couponList">
		<!-- ko foreach: $data -->
		<div class="ticket cky-relative">
			<div class="ticket-border cky-relative" data-bind="attr: { tid: ticketID, shopId: limitUseShopId }, css: { 'ticket-disabled': status > 0 }">
				<div class="ticket-thumb" data-bind="style: { backgroundImage: 'url(/'+ imagePath  +')' }"></div>
				<div class="ticket-amount" data-bind="html: getAmount(typeName, ticketAmount)"></div>
				<div class="ticket-mini">满<span data-bind="text: miniConsumption"></span>可用</div>
				<!-- ko if: content -->
				<div class="ticket-content cky-ellipsis" data-bind="text: content"></div>
				<!-- /ko -->
				<!-- ko ifnot: content -->
				<div class="ticket-content cky-ellipsis" data-bind="text: shopName"></div>
				<!-- /ko -->
				<div class="ticket-date font12">
					<span data-bind="text: efficacySDate"></span>
					--
					<span data-bind="text: efficacyEDate"></span>
				</div>
				
				<!-- 装饰-->
				<ul class="ticket-split"><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li></ul>
				
				<i class="ticket-empty iconfont icon-youhuiquan1"></i>
				
				<div class="ticket-btn">进店看看</div>
				<div class="ticket-nav"><i class="iconfont icon-jiantou"></i></div>
			</div>
			<div class="ticket-ball ticket-ball-top"></div>
			<div class="ticket-ball ticket-ball-bottom"></div>
		</div>
		<!-- /ko -->
	</div>
	<button id="moreButton" class="mui-btn mui-btn-block cky-hidden">更多好券，去领券中心看看<i class="iconfont icon-gengduo"></i></button>
</div>
<script type="text/javascript" src="__KO__"></script>
<script type="text/javascript">
	function getAmount(typeName, ticketAmount) {
		switch(typeName) {
			case "zkq": // 折扣券
				return "<span>" + ticketAmount + "</span><r>折</r>";
			case "djq": // 代金券
				return "<r>¥</r><span>" + ticketAmount + "</span>";
			case "ptq":
				return "<span>" + ticketAmount + "</span>";
		}
		return "";
	}
	
	function getTicketClass(totalCount, usedCount, isReceived) {
		if(!isReceived && totalCount > 0 && totalCount == usedCount) {
			return "ticket-disabled";
		} else if (isReceived) {
			return "ticket-received";
		}
		return "";
	}
	
	$(function(){
		var coupons = [];
		var isEOF = false;
		var force = true;
		var pageNo = 1;
		var type = 0;
		var vm = ko.observableArray(coupons);
		ko.applyBindings(vm, document.getElementById("couponList"));
		function queryByPage() {
			if(force) {
				vm.removeAll();
				coupons.length = 0;
				pageNo = 1;
				isEOF = false;
				force = false;
				$("#couponsLoading").show();
			}
			var _pageNo = pageNo;
			if(!isEOF) {
				$.getJSON("{:U('Activity/pagePersonCoupons')}", {
					pageNo: _pageNo,
					type: type
				}, function(list) {
					if(_pageNo == 1) {
						coupons.length = 0;
						$("#couponsLoading").hide();
						$("#couponList").removeClass("cky-hidden");
					}
					pageNo = ++_pageNo;
					if(list && list.length > 0) {
						$.each(list, function() {
							coupons.push(this);
						});
					}
					vm(coupons);
					
					if(list && list.length < 12) {
						isEOF = true;
						if(type == 0) {
							$("#moreButton").show();
						}
					} else {
						$("#moreButton").hide();
					}
				});
			}
		}
		
		queryByPage();
		
		util.onScrollEnd(queryByPage);
		
		// 跳转事件
		$("#couponList").on("click", ".ticket-border", function() {
			var $this = $(this);
			if(!$this.hasClass("ticket-disabled") && $this.attr('shopId')) {
				// 已领取： 跳转
				window.location.href = "{:U('Shops/detail')}?shopId=" + $this.attr('shopId'); 
			}
		});
		
		var tab = $("#tab");
		// tab页切换
		$(".cky-col-view-cell", tab).click(function() {
			var $this = $(this);
			if(!$this.hasClass("cky-active")) {
				$(".cky-active", tab).removeClass("cky-active");
				$this.addClass("cky-active");
				type = $this.attr("tab-type");
				$("#moreButton").hide();
				force = true;
				queryByPage();
			}
		});
		
		// 更多按钮
		$("#moreButton").click(function() {
			window.location.href = "{:U('Activity/coupon')}";
		});
	});
</script>