<link rel="stylesheet" href="__CSS__/order.css" />
<header class="mui-bar mui-bar-nav cky-bar-gray">
	<button class="cky-back mui-btn mui-btn-link mui-pull-left">
		<i class="mui-icon mui-icon-left-nav"></i>
	</button>
	<h1 id="title" class="mui-title">
		{$title}
	</h1>
</header>
<div class="mui-content">
	<h4 class="order-type cky-mtop-10">
		<switch name="data.orderStatus">
			<case value="0">待付款</case>
			<case value="-1">订单已取消</case>
			<case value="-2">订单已关闭</case>
			<case value="1">等待商家受理</case>
			<case value="2">商家已受理</case>
			<case value="3">订单打包中</case>
			<case value="4">订单配送中</case>
			<case value="5">订单已到货</case>
			<case value="6">订单已结束</case>
		    <default />订单最新状态
		</switch>
	</h4>
	<h5 class="order-type">
		<if condition="$data.orderStatus eq 0">
		订单将在5分钟内关闭，请竟快付款
		</if>
	</h5>
	<div class="status-block">
		<div class="status-block-img
			<switch name="data.orderStatus">
			<case value="0">status-block-img-time</case>
			<case value="-1">status-block-img-close</case>
			<case value="-2">status-block-img-close</case>
		    <default />status-block-img-done
		</switch>
			"></div>
	</div>
	
	<ul class="mui-table-view cky-mtop-10">
		<li class="mui-table-view-cell">
			<a>
				<foreach name="goods" item="item">
				<div class="cky-order-item cky-relative">
					<span>{$item.goodsName}</span>
					<div class="cky-update">
						<span>x {$item.ogoodsNums}</span>
						<span>{$item.ogoodsPrice} 元</span>
					</div>
				</div>
				</foreach>
				
				
				<div id="fast" class="cky-order-item cky-relative">
					<span data-bind="">配送费</span>
					<div class="cky-update">
						<span>{$data.deliveryMoney} 元</span>
					</div>
				</div>
				
				<div class="cky-order-money cky-relative">
					<span>订单金额</span>
					<span>{$data.needPay} 元</span>
				</div>
			</a>
		</li>
	</ul>
</div>

<footer class="cky-footer">
	<if condition="$data.orderStatus eq 0">
	<a id="cancel">取消订单</a>
	<a id="pay" href="{:U('pay')}?orderId={:I('id')}">去付款</a>
	<else/>
		<a id="goshop" href="{:U('Fast/detail')}?id={$data.shopId}">还订这家</a>
	</if>
</footer>
<script>
	$(function() {
		var statusImg = $(".status-block-img");
		<if condition="$data.orderStatus eq 0">
		// 等待付款
		var time = {:strtotime($data['createTime']) + 5 * 60 - time()}; // 5分钟
		timeout(time);
		
		function timeout(time) {
			statusImg.text(util.formatMuites(time));
			time--;
			if(time > -1) {
				window.setTimeout(function() {
					timeout(time);
				}, 1000);
			} else {
				// 倒计时结束
				var ll = cky.loadding();
				$.post("{:U('close')}", { id: {:I('id')} }, function(ret) {
					cky.close(ll);
					if(ret.status == 0) {
						switchCloseStatus(); // 切换到关闭
					} else {
						cky.alert("订单超时");
					}
				});
			}
		}
		
		$("#cancel").click(function() {
			layer.open({
			    content: '是否确定取消该笔订单？',
			    btn: ['确定', '不，再等等'],
			    shadeClose: false,
			    yes: function(){
					var ll = cky.loadding();
					$.post("{:U('orderCancel')}", { orderId: {:I('id')}}, function(result) {
						cky.close(ll);
						if(result) {
							cky.toast("订单已取消");
							window.location.reload();
						} else {
							cky.toast("订单取消失败");
						}
					});
			    }, no: function(){
			        
			    }
			});
		});
		
		/**
		 * 刷新订单状态
		 */
		function switchCloseStatus() {
			$("footer").html("<a id=\"goshop\" href=\"{:U('Fast/detail')}?id={$data.shopId}\">还订这家</a>");
			statusImg.attr("class", "status-block-img status-block-img-close");
			$("h4.order-type").text("订单已关闭");
			$("h5.order-type").empty();
			
			statusImg.empty();
		}
		</if>
	});
</script>