<header class="mui-bar mui-bar-nav cky-bar-gray">
	<button class="mui-btn mui-btn-link mui-pull-left">
		<span id="cityLabel">深圳</span> <i class="iconfont icon-xiala font17 font-gray"></i>
	</button>
	<h1 id="title" class="mui-title">
		<div class="cky-segmented">
			<a class="cky-segmented-item cky-active">全部商家</a>
			<a class="cky-segmented-item">商家活动</a>
		</div>
	</h1>
	<button class="mui-btn mui-btn-link mui-pull-right">
		<i class="iconfont icon-sousuo font24"></i>
	</button>
</header>
<div class="mui-content mui-content-padded mui-content-bottom mui-content-top">
	<nav class="mui-bar	cky-bar cky-top-bar">
		<a class="cky-bar-item">行业 <i class="iconfont icon-xiala font17 font-gray"></i></a>
		<a class="cky-bar-item">全程 <i class="iconfont icon-xiala font17 font-gray"></i></a>
		<a class="cky-bar-item">离我最近 <i class="iconfont icon-xiala font17 font-gray"></i></a>
	</nav>
	<ul id="shopsList" class="cky-table-view">
		<!-- ko foreach: $data -->
		<li class="cky-table-view-cell">
			<a data-bind="attr:{ href: '{:U('shops/detail')}?id=' + shopId }">
				<div class="cky-table-cell-thumb cky-table-cell-thumb80" data-bind="style:{ backgroundImage: 'url(/' + shopImg + ')' }">
					
				</div>
				<div class="cky-media">
					<span class="cky-media-title font20" data-bind="text: shopName"></span>
					<!-- ko if:deliveryOff > 0 && deliveryOff < 1 -->
					<h5 class="cky-right font-red" data-bind="text: (deliveryOff * 10).toFixed(1) + '折'"></h5>
					<!-- /ko -->
					<div class="cky-clearfix"></div>
					<div class="cky-media-sub font15 font-gray2">
						<span class="cky-media-address" data-bind="text: shopAddress + ' ' + catName "></span>
						<span class="cky-right font15 font-gray2" data-bind="text: distance"></span>
					</div>
					<div class="cky-clearfix"></div>
					<span class=" font15 font-gray" data-bind="text: '电话: ' + shopTel"></span>
					<h5 class="cky-right"><i class="iconfont icon-phone font20 font-blue"></i></h5>
					<div class="cky-clearfix"></div>
			    </div>
			</a>
		</li>
		<!-- /ko -->
	</ul>
</div>

<include file="Public:tab"/>
<script type="text/javascript" src="__JS__/geo.location.js?12"></script>
<script type="text/javascript" src="__KO__"></script>

<script type="text/javascript">
	$(function() {
		var location = null;
		geolocation.getCurrentPosition("{$CONF['bmapAK']}", function(evt) {
			if(evt) {
				if(evt.addressComponent) {
					$("#cityLabel").text(evt.addressComponent.city);
				}
				location = evt.location;
			}
			queryByPage();
		});
		
		var isEOF = false;
		var pageNo = 1;
		var shops = [];
		var vm = ko.observableArray(shops);
		ko.applyBindings(vm, document.getElementById("shopsList"));
		function queryByPage() {
			if(!isEOF) {
				var api = "{:U('shops/page', '', '')}";
				$.getJSON(api, { pageNo: pageNo }, function(list) {
					pageNo++;
					if(list && list.length > 0) {
						if(location) {
							var p1 = { x: location.lng, y: location.lat };
							var p2 = { x: 0, y: 0 };
						}
						$.each(list, function() {
							this.distance = "";
							if(location) {
								p2.x = this.longitude;
								p2.y = this.latitude;
								var meters = geolocation.distanceBetween(p1, p2);
								this.distance = geolocation.distanceToReadability(meters);
							}
							shops.push(this);
						});
						vm(shops);
					}
					
					if(list && list.length < 10) {
						isEOF = true;
					}
				});
			}
		}
	});
</script>